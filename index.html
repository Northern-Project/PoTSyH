<!doctype html>
<html lang="ja">
<head>
 <meta charset="UTF-8">
 <meta name="viewport" content="width=device-width, initial-scale=1" />
 <title>新〇ニスの王〇様　Shoot Your Heart!!</title>
 <style>
  body { font-family: sans-serif; height: 100%;overflow: hidden;   /* スマホゲーム向け */
  margin: 0;
  padding: 0;}
  .nav { display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 12px; }
  button {padding: 10px 14px; }

.imgBtn{
  width:64px; height:64px;
padding: 20px 24px;
  margin: 20px 10px;
  row-gap: 20px;
border:none;
  cursor:pointer;

  background-color: transparent;
  background-position: center;
  background-repeat: no-repeat;
  background-size: contain; /* 通常ボタンはこれでOK */

  transition:transform .12s ease, filter .12s ease;
  filter: drop-shadow(0 8px 14px rgba(0,0,0,.45));
  animation: var(--float), var(--glow), var(--sprite);
}
.nav1{ background-image:url("assets/ui/btn_1.png"); }  
.glowBtn{--glow: glow 1.5s infinite alternate;
}
.floatBtn{
  --float: float 2s ease-in-out infinite;
}
.spriteBtn{
  --sprite: sprite 2.4s steps(1) infinite;
  background-size: 192px 64px; /* 64*3 , 64 */
}

@keyframes sprite{
  0%    { background-position:   0px 0; }
  33.33%{ background-position: -64px 0; }
  66.66%{ background-position:-128px 0; }
  100%  { background-position:-128px 0; }
}
@keyframes float{
  0%{ transform: translateY(0px); }
  50%{ transform: translateY(-8px); }
  100%{ transform: translateY(0px); }
}

@keyframes glow{
  from{
    filter: drop-shadow(0 8px 14px rgba(0,0,0,.45))
            drop-shadow(0 0 5px #000000);
  }
  to{
    filter: drop-shadow(0 8px 14px rgba(0,0,0,.45))
            drop-shadow(0 0 20px #000000);
  }
}
#p1{ background:url("assets/bg/bg_page1.png") center/cover no-repeat; }
.page{ color:#fff;  min-height: 100vh; background-size: cover; overflow: hidden;  box-sizing: border-box;}
.page::before{
  content:"";
  position:absolute;
  inset:0;
  background:rgba(0,0,0,0.35);
  border-radius:10px;
  pointer-events:none;
}
.page{ position:relative; }
.page > *{ position:relative; } /* 暗幕より前に出す */  
.page{ display:none; }
.active { display: block; }

#field{
  position: relative;
  width: 100%;
  height: 70vh;           /* 画面の70%をゲームエリアに */
  background: #111;
  overflow: hidden;
  touch-action: none;     /* スマホでスクロール防止 */
}

#player{
  position: absolute;
  width: 64px;
  height: 64px;
  left: 0;
  top: 0;
  transform:none;
  pointer-events: none;   /* 主人公をタップしても反応しない */
}
 </style>
</head>

<body>

 <div id="p1" class="page active">
 <button class="imgBtn nav1 floatBtn glowBtn spriteBtn" data-g="1" aria-label="Page1"></button>
  <button data-g="2">2</button>
  <h3>Page1</h3>
  前回： A=<span id="sA"></span> B=<span id="sB"></span>
 <button onclick="selectChar('char1')">キャラ1</button>
<button onclick="selectChar('char2')">キャラ2</button>
 </div>

 <div id="p2" class="page">
 <button class="imgBtn nav1 floatBtn glowBtn spriteBtn" data-g="1" aria-label="Page1"></button>
   <div id="field">
    <img id="player" src="assets/player/char1_normal1.png">
  </div>
  <button data-g="3">3</button>
  <button data-g="4">4</button>
  <button data-g="5">5</button>
 </div>

 <div id="p3" class="page">
<button class="imgBtn nav1 floatBtn glowBtn spriteBtn" data-g="1" aria-label="Page1"></button>
  <button data-g="2">2</button>
  <button data-g="3">3</button>
  <button data-g="4">4</button>
  <button data-g="5">5</button>
  <h3>Page3</h3>
  <button id="Ap">A+1</button>
  <button id="Am">A-1</button>
  <br><br>
  <input id="Bin" type="number">
  <button id="Bok">B反映</button>
 </div>

 <div id="p4" class="page">
<button class="imgBtn nav1 floatBtn glowBtn spriteBtn" data-g="1" aria-label="Page1"></button>
<div style="margin-top:12px; padding:12px; border:1px solid #fff; border-radius:10px; max-width:360px;">
  <h3>Page4</h3>

  <div style="margin:8px 0;">
    <label for="bgmBattleSelect">Page2 戦闘BGM：</label><br>
    <select id="bgmBattleSelect">
      <option value="random">ランダムループ（3曲）</option>
      <option value="1">1曲目をループ</option>
      <option value="2">2曲目をループ</option>
      <option value="3">3曲目をループ</option>
    </select>
  </div>

  <button id="bgmToggle">BGM: ON</button>
</div>

  <button data-g="2">2</button>
  <button data-g="3">3</button>
  <button data-g="4">4</button>
  <button data-g="5">5</button>
  <h3>Page4</h3>
  Hello World!
 </div>

 <div id="p5" class="page">
<button class="imgBtn nav1 floatBtn glowBtn spriteBtn" data-g="1" aria-label="Page1"></button>
  <button data-g="2">2</button>
  <button data-g="3">3</button>
  <button data-g="4">4</button>
  <button data-g="5">5</button>
  <h3>Page5</h3>
  A=<span id="vA"></span><br>
  B=<span id="vB"></span>
 </div>

 <script>
const field = document.getElementById("field");
const player = document.getElementById("player");

let d = JSON.parse(localStorage.getItem("save")) || {A:0,B:0};

let currentChar = "char1";

let playerX = 0;
let playerY = 0;
let targetX = 0;
let targetY = 0;
let playerCX = 0, playerCY = 0;   // プレイヤー中心
let targetCX = 0, targetCY = 0;   // 目標中心
let boostFrames = 0;

// ===== BGM Manager =====
const BGM = {
  enabled: true,
  audio: new Audio(),
  currentSrc: "",
  battleMode: "random", // "random" or "1"/"2"/"3"
  battleList: [
    "assets/audio/bgm_battle_01.mp3",
    "assets/audio/bgm_battle_02.mp3",
    "assets/audio/bgm_battle_03.mp3",
  ],
  title: "assets/audio/bgm_title.mp3",
  menu:  "assets/audio/bgm_menu.mp3",
};

BGM.audio.volume = 0.5; // 0.0〜1.0 好きに調整

function bgmPlay(src, loop=true){
  if(!BGM.enabled) return;

  if(BGM.currentSrc !== src){
    BGM.audio.pause();
    BGM.audio.src = src;
    BGM.currentSrc = src;
  }
  BGM.audio.loop = loop;

  // モバイル対策：再生がブロックされる場合があるので catch
  BGM.audio.play().catch(()=>{ /* 初回ジェスチャーが必要な時は無視 */ });
}

function bgmStop(){
  BGM.audio.pause();
}

function pickRandomBattle(){
  const i = Math.floor(Math.random() * BGM.battleList.length);
  return BGM.battleList[i];
}

function applyBattleBgm(){
  if(BGM.battleMode === "random"){
    bgmPlay(pickRandomBattle(), false); // endedで次を選ぶ
  }else{
    const idx = Number(BGM.battleMode) - 1;
    bgmPlay(BGM.battleList[idx], true);
  }
}

// ランダムループ用：曲が終わったら次へ
BGM.audio.addEventListener("ended", ()=>{
  if(!BGM.enabled) return;
  if(!document.getElementById("p2").classList.contains("active")) return;
  if(BGM.battleMode !== "random") return;

  bgmPlay(pickRandomBattle(), false);
});



/* ---------------- キャラ切替 ---------------- */

function updatePlayerImage(state){
  player.src = `assets/player/${currentChar}/${state}.png`;
}

function selectChar(name){
  currentChar = name;
  updatePlayerImage("normal");
}

/* ---------------- 初期化関数　---------------- */

function initPlayerPosition(){

  playerCX = field.clientWidth / 2;
  playerCY = field.clientHeight * 0.8;  // 中央より少し下

  targetCX = playerCX;
  targetCY = playerCY;

 player.style.left = (playerCX - player.offsetWidth/2) + "px";
  player.style.top  = (playerCY - player.offsetHeight/2) + "px";
}




/* ---------------- 移動処理 ---------------- */


function setTarget(x, y){
  const halfW = player.offsetWidth / 2;
  const halfH = player.offsetHeight / 2;
  const pad = 8; // 端から8pxは空ける
  // 中心が行ける範囲（左右上下を同じ条件にする）
  targetCX = Math.max(halfW, Math.min(x, field.clientWidth  - halfW));
  targetCY = Math.max(halfH, Math.min(y, field.clientHeight - halfH));

  boostFrames = 8;  // 最初の8フレームだけ速くする（調整OK）
}

/* ---------------- UI更新 ---------------- */

function ui(){
  sA.textContent = vA.textContent = d.A;
  sB.textContent = vB.textContent = d.B;
  Bin.value = d.B;
  localStorage.setItem("save", JSON.stringify(d));
}

document.addEventListener("click", e=>{
  const btn = e.target.closest("[data-g]");
  if(!btn) return;

  // ページ切替
  document.querySelectorAll(".page").forEach(p=>p.classList.remove("active"));

  const pageNum = btn.dataset.g;
  const nextPage = document.getElementById("p" + pageNum);
  nextPage.classList.add("active");

  // Page2を開いた時だけ初期化
  if(pageNum === "2"){
    initPlayerPosition();
  }

  // ページに応じてBGMを切り替える
  if(pageNum === "1"){
    bgmPlay(BGM.title, true);
  }else if(pageNum === "2"){
    applyBattleBgm();
  }else{ // 3〜5
    bgmPlay(BGM.menu, true);
  }
});
/* ---------------- ボタン処理 ---------------- */

Ap.onclick = ()=>{ d.A++; ui(); }
Am.onclick = ()=>{ d.A--; ui(); }
Bok.onclick = ()=>{ d.B = +Bin.value || 0; ui(); }

/* ---------------- フィールド操作 ---------------- */
let mouseDown = false;

function isP2Active(){
  return document.getElementById("p2").classList.contains("active");
}

/* --- マウス --- */
field.addEventListener("mousedown", ()=>{
  if(!isP2Active()) return;
  mouseDown = true;
});

window.addEventListener("mouseup", ()=>{  // ←フィールド外で離しても止まる
  mouseDown = false;
});

field.addEventListener("mousemove", e=>{
  if(!isP2Active()) return;
  if(!mouseDown) return;

  const rect = field.getBoundingClientRect();
  setTarget(e.clientX - rect.left, e.clientY - rect.top);
});

field.addEventListener("click", e=>{
  if(!isP2Active()) return;

  const rect = field.getBoundingClientRect();
  setTarget(e.clientX - rect.left, e.clientY - rect.top);
});

/* --- スマホ --- */
field.addEventListener("touchmove", e=>{
  if(!isP2Active()) return;

  e.preventDefault();
  const rect = field.getBoundingClientRect();
  const touch = e.touches[0];
  setTarget(touch.clientX - rect.left, touch.clientY - rect.top);
}, { passive:false });

field.addEventListener("touchstart", e=>{
  if(!isP2Active()) return;

  e.preventDefault();
  const rect = field.getBoundingClientRect();
  const touch = e.touches[0];
  setTarget(touch.clientX - rect.left, touch.clientY - rect.top);
}, { passive:false });

/* ---------------- ゲームループ ---------------- */

function gameLoop(){
  if(document.getElementById("p2").classList.contains("active")){

    const dx = targetCX - playerCX;
    const dy = targetCY - playerCY;
    const dist = Math.hypot(dx, dy);

const baseSpeed = 3;
const boostSpeed = 7;
const speed = (boostFrames > 0) ? boostSpeed : baseSpeed;
if(boostFrames > 0) boostFrames--;

    if(dist > speed){
      updatePlayerImage("walk");
      playerCX += dx / dist * speed;
      playerCY += dy / dist * speed;
    }else{
      updatePlayerImage("normal");
      playerCX = targetCX;
      playerCY = targetCY;
    }

    player.style.left = (playerCX - player.offsetWidth/2) + "px";
    player.style.top  = (playerCY - player.offsetHeight/2) + "px";
  }
  requestAnimationFrame(gameLoop);
}
/* ---------------- 初期化 ---------------- */

window.addEventListener("load", ()=>{
  playerCX = field.clientWidth / 2;
  playerCY = field.clientHeight * 0.8;

  targetCX = playerCX;
  targetCY = playerCY;

  player.style.left = (playerCX - player.offsetWidth/2) + "px";
  player.style.top  = (playerCY - player.offsetHeight/2) + "px";

  updatePlayerImage("normal");
  ui();
  gameLoop();
});

// ===== Page4 UI =====
const bgmBattleSelect = document.getElementById("bgmBattleSelect");
const bgmToggle = document.getElementById("bgmToggle");

// 保存読み込み
BGM.battleMode = localStorage.getItem("bgm_battle_mode") || "random";
bgmBattleSelect.value = BGM.battleMode;

BGM.enabled = (localStorage.getItem("bgm_enabled") ?? "1") === "1";
bgmToggle.textContent = "BGM: " + (BGM.enabled ? "ON" : "OFF");

// プルダウン変更
bgmBattleSelect.addEventListener("change", ()=>{
  BGM.battleMode = bgmBattleSelect.value;
  localStorage.setItem("bgm_battle_mode", BGM.battleMode);

  // いまPage2なら即反映
  if(document.getElementById("p2").classList.contains("active")){
    applyBattleBgm();
  }
});

// ON/OFF
bgmToggle.addEventListener("click", ()=>{
  BGM.enabled = !BGM.enabled;
  localStorage.setItem("bgm_enabled", BGM.enabled ? "1" : "0");
  bgmToggle.textContent = "BGM: " + (BGM.enabled ? "ON" : "OFF");

  if(!BGM.enabled){
    bgmStop();
  }else{
    // 今いるページのBGMを再開
    if(document.getElementById("p1").classList.contains("active")) bgmPlay(BGM.title, true);
    else if(document.getElementById("p2").classList.contains("active")) applyBattleBgm();
    else bgmPlay(BGM.menu, true);
  }
});

  </script>
</body>
</html>